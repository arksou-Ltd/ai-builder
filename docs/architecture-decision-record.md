# ai-builder 架构决策记录

**文档版本：** 1.0
**创建日期：** 2026-02-01
**状态：** 已确认

---

## 目录

1. [执行摘要](#执行摘要)
2. [核心架构决策](#核心架构决策)
3. [技术选型详情](#技术选型详情)
4. [E2B 云端沙箱方案](#e2b-云端沙箱方案)
5. [状态管理与持久化](#状态管理与持久化)
6. [技术栈总览](#技术栈总览)
7. [决策依据与备选方案](#决策依据与备选方案)

---

## 执行摘要

ai-builder 采用 **Web 端 + E2B 云端沙箱** 架构，实现以下目标：

| 目标 | 实现方式 |
|------|----------|
| 零技术门槛 | 纯 Web 端，无需安装任何软件 |
| 完整 Git 能力 | E2B Sandbox 内执行所有 Git 操作 |
| 代码不持久存储 | Sandbox 临时执行，任务后销毁 |
| 安全隔离 | 每个任务独立 Firecracker microVM |
| AI CLI 工具支持 | Sandbox 内可运行 Claude Code CLI |

---

## 核心架构决策

### 决策 1：Web 端 vs 桌面客户端

**决策：采用纯 Web 端**

| 评估维度 | Web 端 | 桌面客户端 |
|----------|--------|-----------|
| 用户获取门槛 | 浏览器即用 ⭐ | 需下载安装 |
| 功能实现 | 所有功能可实现 ⭐ | 所有功能可实现 |
| PRD 定义 | 完全一致 ⭐ | 不符合 PRD |
| 目标用户 | PM 零门槛 ⭐ | 需说服安装 |
| 迭代速度 | 部署即更新 ⭐ | 需打包分发 |
| 开发成本 | 标准 Web 开发 ⭐ | 需额外维护跨平台 |

**决策依据：**

1. PRD 明确定义："SaaS（无本地安装）—— 用户通过浏览器访问，无需安装客户端或 CLI"
2. 终端所有功能（表单、对话、进度展示）Web 完全可以实现
3. 所有重操作（Git、AI 调用、代码生成）在服务器/E2B 端执行
4. 零技术背景的 PM 用户，"发个链接就能用"优于"下载安装"

### 决策 2：前端框架选择

**决策：Next.js（而非 Vite + React）**

| 维度 | Next.js | Vite + React |
|------|---------|--------------|
| SSR/SEO | 内置支持 ⭐ | 需额外配置 |
| API Routes | 内置 ⭐ | 需单独后端 |
| 部署 | Vercel 一键 ⭐ | 需配置 |
| 文件路由 | 内置 ⭐ | 需 React Router |
| 生态成熟度 | 非常成熟 ⭐ | 成熟 |

**决策依据：**

1. SaaS 产品需要 SEO（产品官网 + 文档页）
2. API Routes 可处理简单后端逻辑，减少架构复杂度
3. Vercel 部署简单，适合快速迭代
4. 对于 Web 应用（非桌面应用），Next.js 是更合适的选择

> **注意**：之前讨论过 Tauri + Vite + React 方案用于桌面端。该方案技术上可行，但基于功能需求分析，Web 端更适合 ai-builder，因此未采用。

### 决策 3：代码执行环境

**决策：E2B 云端沙箱**

**问题背景：**
- ai-builder 需要执行 Git 操作（clone、commit、push、PR）
- 需要运行 AI 代码生成工具（可能是 CLI）
- PRD 要求"不存储用户代码内容"

**方案对比：**

| 方案 | 描述 | 优点 | 缺点 |
|------|------|------|------|
| **A: 服务器 Clone** | 服务器直接 clone 仓库执行 | Web 前端简单 | 服务器存储代码，信任问题 |
| **B: 桌面端本地** | 用户本地 clone 执行 | 代码不经服务器 | 需要桌面客户端，PM 难以配置 |
| **C: E2B 沙箱** ⭐ | 云端隔离 sandbox 执行 | Web 前端 + 不持久存储 + 完整能力 | 需要第三方服务 |

**选择 E2B 的原因：**

1. 完美平衡 Web 端体验与完整 Git/CLI 能力
2. Sandbox 临时创建，任务后销毁，符合"不持久存储代码"要求
3. 基于 Firecracker microVM，企业级安全隔离
4. 成熟的生产案例（Perplexity、Manus、88% Fortune 100）
5. 按需计费，成本可控

---

## E2B 云端沙箱方案

### E2B 核心特性

| 特性 | 说明 |
|------|------|
| **底层技术** | Firecracker microVM（AWS Lambda 同款） |
| **启动速度** | ~150ms 冷启动 |
| **连续运行** | 最长 24 小时（Pro）/ 1 小时（Base） |
| **暂停保持** | 最长 30 天（完整状态：文件系统 + 内存） |
| **总生命周期** | 从创建到销毁最长 30 天 |
| **隔离性** | 完全隔离的 Linux 环境 |
| **能力** | 文件系统、终端命令、网络访问、任意语言运行时 |
| **安全认证** | SOC2 Type 1 |

### 定价估算

| 场景 | 预估时长 | 预估成本 |
|------|----------|----------|
| 单个 Story 开发 | 5-10 分钟 | $0.008 - $0.017 |
| 完整 Epic (5 Stories) | 30-60 分钟 | $0.05 - $0.10 |
| 月活用户 100 个需求 | 500-1000 分钟 | $0.83 - $1.67 |

### E2B Sandbox 工作流

```
用户发起 Story 开发
        │
        ▼
┌─────────────────────────────────────────────────────────┐
│  E2B Sandbox 创建（~150ms）                              │
│                                                         │
│  1. git clone 用户授权的 GitHub 仓库                     │
│  2. 读取项目规范文档（README、架构文档）                  │
│  3. 运行 AI 代码生成（Claude Code CLI 或 Claude API）    │
│  4. AI 生成代码 → 写入文件                              │
│  5. git add → git commit → git push                    │
│  6. gh pr create（创建 PR）                             │
│  7. 返回结果                                            │
│                                                         │
│  任务完成 → Sandbox 销毁 / 用户离开 → Sandbox 暂停       │
└─────────────────────────────────────────────────────────┘
```

### Git 操作支持

E2B 完全支持在 Sandbox 内执行 Git 操作：

```python
# 示例：在 E2B Sandbox 中执行 Git 操作
sandbox.process.start_and_wait("git clone <repo_url> .")
sandbox.process.start_and_wait("git checkout -b feature/new-feature")
sandbox.process.start_and_wait("git add -A")
sandbox.process.start_and_wait("git commit -m 'feat: add new feature'")
sandbox.process.start_and_wait("git push -u origin feature/new-feature")
sandbox.process.start_and_wait("gh pr create --title 'Add new feature' --body '...'")
```

**生产案例验证：** Maige 项目已使用 E2B 实现完整的 clone → 开发 → commit → PR 工作流。

---

## 状态管理与持久化

### 24 小时限制的解决方案

**E2B Pause/Resume 机制：**

| 状态 | 说明 |
|------|------|
| **Running** | 运行中，最长连续 24 小时 |
| **Paused** | 已暂停，保留完整状态（文件 + 内存），最长 30 天 |
| **Killed** | 已销毁，资源释放 |

**关键特性：** 恢复（Resume）后，24 小时连续运行限制重置。

### 三层状态管理策略

```
┌─────────────────────────────────────────────────────────────┐
│                 ai-builder 状态管理策略                       │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  Layer 1: E2B Sandbox 状态（短期）                           │
│  ├─ 运行中：代码、文件、进程都在 sandbox 内                    │
│  ├─ 暂停时：完整状态保留（文件系统 + 内存）                     │
│  └─ 可保持最长 30 天                                         │
│                                                             │
│  Layer 2: 后端数据库持久化（永久）                            │
│  ├─ sandbox_id：当前 sandbox 的 ID                          │
│  ├─ 工作流状态：当前步骤、史诗/故事状态                        │
│  ├─ 临时分支名：如果有未提交代码，记录分支名                    │
│  └─ 最后活动时间：用于判断是否需要暂停                         │
│                                                             │
│  Layer 3: Git 临时分支（安全网，永久）                        │
│  ├─ 定期 auto-commit 到临时分支（如每 30 分钟）               │
│  ├─ 即使 sandbox 意外销毁，代码也不会丢失                      │
│  └─ 最终提交 PR 时，squash 成干净的 commit                   │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

### 边界情况处理

| 情况 | 处理策略 |
|------|----------|
| **用户临时离开** | 30 分钟无操作自动暂停 sandbox |
| **用户次日继续** | Resume sandbox，24 小时限制重置 |
| **超过 30 天未操作** | 从 Git 临时分支重建 sandbox |
| **Sandbox 意外崩溃** | 从最近的 auto-commit 恢复 |
| **网络中断** | 定期 auto-commit 确保代码不丢失 |

### 性能指标

| 操作 | 耗时 |
|------|------|
| Sandbox 创建 | ~150ms |
| Sandbox 暂停 | ~4 秒/GiB RAM |
| Sandbox 恢复 | ~1 秒 |
| 从 Git 重建 | ~30-60 秒（clone + 安装依赖） |

---

## 技术栈总览

### 最终技术栈

```
┌─────────────────────────────────────────────────────────────┐
│                    ai-builder 技术栈                         │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  前端 (Web)                                                  │
│  ├─ Next.js 14/15 (App Router)                              │
│  ├─ TypeScript                                              │
│  ├─ Tailwind CSS + shadcn/ui                                │
│  ├─ Zustand（状态管理）                                      │
│  └─ Socket.io-client（实时通信）                             │
│                                                             │
│  后端                                                        │
│  ├─ Next.js API Routes 或 独立 Node.js 服务                  │
│  ├─ E2B SDK (@e2b/code-interpreter)                         │
│  ├─ Prisma + PostgreSQL（数据持久化）                        │
│  └─ Socket.io（实时推送）                                    │
│                                                             │
│  AI 代码执行 (E2B Sandbox)                                   │
│  ├─ 自定义 Sandbox Template                                 │
│  │   ├─ 预装 Git、gh CLI                                    │
│  │   ├─ 预装 Claude Code CLI（可选）                         │
│  │   └─ 预装项目类型运行时（Node.js/Java/Flutter）           │
│  └─ 按需创建，任务后销毁或暂停                                │
│                                                             │
│  外部服务集成                                                 │
│  ├─ GitHub API（OAuth、仓库操作、PR）                        │
│  ├─ E2B API（Sandbox 管理）                                  │
│  ├─ Codex API（需求交流、Story 生成、Code Review）           │
│  └─ Claude API / Claude Code（代码生成）                     │
│                                                             │
│  部署                                                        │
│  ├─ Vercel（前端 + API Routes）                              │
│  └─ 或 自建服务器（如需更多控制）                             │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

### 架构图

```
┌─────────────────────────────────────────────────────────────────┐
│                        用户 (浏览器)                             │
│                              │                                  │
│                      Next.js Web 前端                           │
│                    (对话界面 + 工作流可视化)                      │
└─────────────────────────────────────────────────────────────────┘
                               │
                               │ HTTPS / WebSocket
                               ▼
┌─────────────────────────────────────────────────────────────────┐
│                         后端服务器                               │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────────────────┐ │
│  │ GitHub OAuth│  │ 状态管理     │  │ E2B Sandbox 编排        │ │
│  │ 用户认证    │  │ 工作流引擎   │  │ 创建/暂停/恢复/销毁      │ │
│  └─────────────┘  └─────────────┘  └─────────────────────────┘ │
│                                                                 │
│  ┌─────────────────────────────────────────────────────────┐   │
│  │                    数据库 (PostgreSQL)                   │   │
│  │  用户 | 项目 | 史诗 | 故事 | Sandbox状态 | AI配置        │   │
│  └─────────────────────────────────────────────────────────┘   │
└─────────────────────────────────────────────────────────────────┘
                               │
           ┌───────────────────┼───────────────────┐
           │                   │                   │
           ▼                   ▼                   ▼
    ┌─────────────┐    ┌─────────────┐    ┌─────────────┐
    │  GitHub API │    │   E2B API   │    │   AI API    │
    │  仓库/PR    │    │   Sandbox   │    │ Codex/Claude│
    └─────────────┘    └─────────────┘    └─────────────┘
                               │
                               ▼
              ┌─────────────────────────────────┐
              │     E2B Cloud Sandbox           │
              │  ┌───────────────────────────┐  │
              │  │ - git clone 仓库           │  │
              │  │ - 读取项目规范             │  │
              │  │ - AI 生成代码              │  │
              │  │ - git commit/push         │  │
              │  │ - gh pr create            │  │
              │  └───────────────────────────┘  │
              │     (临时执行，任务后销毁)       │
              └─────────────────────────────────┘
```

---

## 决策依据与备选方案

### 已评估但未采用的方案

#### 方案 A：Tauri 桌面客户端

**技术特点：**
- Tauri 2.0 + Vite + React
- 包体积小（2-10MB），内存占用低（30-80MB）
- 启动快（<500ms）
- 支持移动端（iOS/Android）

**未采用原因：**
1. PRD 定义为 SaaS Web UI，非桌面客户端
2. 基于功能需求分析，终端所有功能 Web 可实现
3. PM 用户对"安装软件"有心理门槛
4. 所有重操作在服务器/E2B 端执行，桌面端无额外优势

**保留价值：** 如未来需要桌面增强版（如面向企业的私有化部署），Tauri 是优选方案。

#### 方案 B：服务器直接 Clone 仓库

**技术特点：**
- 后端服务器直接 clone 用户仓库到服务器磁盘
- 服务器执行 AI 代码生成和 Git 操作

**未采用原因：**
1. 违反 PRD 要求"不存储用户代码内容"
2. 代码经过我方服务器，存在信任和合规风险
3. 服务器资源消耗大（每用户需要存储空间）

#### 方案 C：纯 API 模式（GitHub API + Claude API）

**技术特点：**
- 不 clone 仓库，通过 GitHub API 读取/写入文件
- 通过 Claude API（非 CLI）生成代码
- 通过 GitHub API 创建 commit 和 PR

**未采用原因：**
1. 无法使用 Claude Code CLI 的完整能力
2. 需要自行实现复杂的代码上下文组装
3. GitHub API 有速率限制
4. 大型仓库性能较差

### 关键决策总结

| 决策点 | 选择 | 核心原因 |
|--------|------|----------|
| 客户端形态 | Web 端 | PRD 定义 + PM 用户零门槛 |
| 前端框架 | Next.js | SaaS 产品需要 SSR/SEO + API Routes |
| 代码执行环境 | E2B 云端沙箱 | 平衡 Web 体验与完整 Git/CLI 能力 |
| 状态管理 | 三层策略 | 确保用户工作永不丢失 |

---

## 附录

### 参考资料

- [E2B 官方文档](https://e2b.dev/docs)
- [E2B Sandbox 持久化](https://e2b.dev/docs/sandbox/persistence)
- [E2B 定价](https://e2b.dev/pricing)
- [Maige 案例：使用 E2B 实现 Git 工作流](https://e2b.dev/blog/building-open-source-codebase-copilot-with-code-execution-layer)

### 文档变更历史

| 版本 | 日期 | 变更内容 |
|------|------|----------|
| 1.0 | 2026-02-01 | 初始版本，记录核心架构决策 |
